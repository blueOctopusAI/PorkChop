{% extends "base.html" %}

{% block title %}{{ bill.bill_type | upper }} {{ bill.bill_number }}{% endblock %}
{% block description %}Analysis of {{ bill.title }}{% endblock %}

{% block content %}
<article class="bill-detail">
    <header>
        <h1>{{ bill.bill_type | upper }} {{ bill.bill_number }}</h1>
        <h2>{{ bill.title }}</h2>
        <div class="bill-meta">
            <span>{{ bill.congress }}th Congress</span>
            {% if bill.introduced_date %}<span>Introduced: {{ bill.introduced_date }}</span>{% endif %}
            {% if bill.sponsors %}<span>Sponsors: {{ bill.sponsors }}</span>{% endif %}
            {% if bill.status %}<span>Status: {{ bill.status }}</span>{% endif %}
        </div>
        <div class="bill-actions">
            <a href="/bill/{{ bill.id }}/spending" class="btn">Spending Detail</a>
            {% if versions|length > 1 %}
            <a href="/bill/{{ bill.id }}/compare" class="btn">Compare Versions</a>
            {% endif %}
        </div>
    </header>

    {% if summary %}
    <section class="summary">
        <h3>Summary</h3>
        <div class="summary-text">{{ summary }}</div>
    </section>
    {% endif %}

    {% if pork and pork.scored_items %}
    <section class="pork-summary">
        <h3>Pork Score</h3>
        <div class="stat-cards">
            <div class="stat-card {% if pork.avg_score > 50 %}warn{% endif %}">
                <span class="stat-number">{{ "%.0f"|format(pork.avg_score) }}</span>
                <span class="stat-label">Avg Score</span>
            </div>
            <div class="stat-card {% if pork.max_score > 70 %}warn{% endif %}">
                <span class="stat-number">{{ pork.max_score }}</span>
                <span class="stat-label">Max Score</span>
            </div>
            <div class="stat-card">
                <span class="stat-number">{{ pork.scored_items }}</span>
                <span class="stat-label">Items Scored</span>
            </div>
            <div class="stat-card {% if pork.high_pork_count > 0 %}warn{% endif %}">
                <span class="stat-number">{{ pork.high_pork_count }}</span>
                <span class="stat-label">High Pork</span>
            </div>
        </div>
    </section>
    {% endif %}

    <section class="spending-overview">
        <h3>Spending: ${{ "{:,.0f}".format(total_spending) }}</h3>
        {% if spending %}
        <table>
            <thead>
                <tr>
                    <th>Amount</th>
                    <th>Purpose</th>
                    <th>Availability</th>
                </tr>
            </thead>
            <tbody>
                {% for item in spending[:20] %}
                <tr>
                    <td class="amount">${{ "{:,.0f}".format(item.amount_numeric) if item.amount_numeric else item.amount }}</td>
                    <td>{{ item.purpose or 'unspecified' }}</td>
                    <td>{{ item.availability or '-' }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% if spending|length > 20 %}
        <p><a href="/bill/{{ bill.id }}/spending">View all {{ spending|length }} spending items</a></p>
        {% endif %}
        {% endif %}
    </section>

    {% if deadlines %}
    <section class="deadlines">
        <h3>Deadlines ({{ deadlines|length }})</h3>
        <table>
            <thead>
                <tr><th>Date</th><th>Action</th><th>Responsible</th></tr>
            </thead>
            <tbody>
                {% for dl in deadlines %}
                <tr>
                    <td>{{ dl.date or '-' }}</td>
                    <td>{{ dl.action or '-' }}</td>
                    <td>{{ dl.responsible_entity or '-' }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </section>
    {% endif %}

    {% if refs %}
    <section class="references">
        <h3>Legal References ({{ refs|length }})</h3>
        <div class="tag-list">
            {% for ref in refs %}
            <span class="tag tag-{{ ref.ref_type }}">{{ ref.ref_text }}</span>
            {% endfor %}
        </div>
    </section>
    {% endif %}

    {% if entities %}
    <section class="entities">
        <h3>Entities ({{ entities|length }})</h3>
        <div class="tag-list">
            {% for e in entities %}
            <span class="tag">{{ e.name }}{% if e.role %} ({{ e.role }}){% endif %}</span>
            {% endfor %}
        </div>
    </section>
    {% endif %}

    {% if versions %}
    <section class="versions">
        <h3>Versions</h3>
        <table>
            <thead><tr><th>Code</th><th>Name</th><th>Fetched</th></tr></thead>
            <tbody>
                {% for v in versions %}
                <tr>
                    <td>{{ v.version_code }}</td>
                    <td>{{ v.version_name or '-' }}</td>
                    <td>{{ v.fetched_at[:10] if v.fetched_at else '-' }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </section>
    {% endif %}
</article>
{% endblock %}
